<?php

namespace App\Admin\Controllers;

use App\Order;
use Encore\Admin\Controllers\AdminController;
use Encore\Admin\Form;
use Encore\Admin\Grid;
use Encore\Admin\Show;
use App\Salelist;
use App\Hospital;
use Encore\Admin\Facades\Admin;
use Illuminate\Support\Facades\DB;
use Encore\Admin\Widgets\Table;
class OrderController extends AdminController
{
    /**
     * Title for current resource.
     *
     * @var string
     */
    protected $title = '订单';

    /**
     * Make a grid builder.
     *
     * @return Grid
     */
    protected function grid()
    {
        $grid = new Grid(new Order());
        $grid->quickSearch(function($model, $query){
            $model->orWhere('orderid','like','%'.$query.'%');
            $buyerid = Salelist::where('name',$query)->orWhere('telephone',$query)->value('id');
            if($buyerid){
                $model->orWhere('buyerid', $buyerid);
            }
            $hospitalid = Hospital::where('hospital','like','%'.$query.'%')->value('id');
            if($hospitalid){
                $model->orWhere('hospital', $hospitalid);
            }
        });
        $user_id = Admin::user()->id;
        $username = DB::table('admin_users')->where('id',$user_id)->value('username');
        $buyerid = Salelist::where('telephone',$username)->value('id');
        $buyertype = Salelist::where('telephone',$username)->value('type');
        $user_roles = Admin::user()->roles->toArray();
        if($user_roles[0]['id'] ==4 || $user_roles[0]['id'] ==5){
            $grid->model()->where(function($query) use($buyerid){
                $query->where('buyerid', $buyerid);
            });
        }

        $grid->column('orderid','订单号');
        $grid->column('totalprice', '订单金额');
        $grid->column('orderinfo','订单详情')->display(function(){
            return '<button class="btn btn-primary btn-xs">查看</button>';
        })->modal('订单内容',function(){
            $arr = json_decode($this->orderinfo, true);
            foreach ($arr as $key =>$val){
                $arr[$key]['price_t'] = $val['num']*$val['price'];
            }
            return new Table(['id','药品名称','产品编号','数量','单价','小计'], $arr);
        });
        $grid->column('buyerid','下单人')->display(function($buyerid){
            return Salelist::where('id',$buyerid)->value('name');
        });
        if($user_roles[0]['id'] == 4){
            $grid->column('gift','赠品')->display(function($gift){
                 if($this->orderstatus !=1 ){
                     return $gift;
                 }else{
                     return '<button class="btn btn-primary btn-xs"  data-toggle="modal" data-target="#grid-modal>设置赠品</button>';
                 }
             });
             
        }
        $grid->column('orderstatus','订单状态')->display(function($orderstatus) use($user_roles){
            $js = <<<SCRIPT
            $(".comfirmorder").click(function(){
                id = $(this).attr('data-id');
                $.ajaxSetup({headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')}});
                $.ajax({
                    url:'/admin/api/changestatus',
                    method:'post',
                    data:{'id':id},
                    success:function(res){
                        if(res.status){        
                                toastr.success(res.msg,res.title,setTimeout(function (){
                                	       window.location.reload();
                                            }, 4000)
                                        )
                            }else{
                                toastr.warning(res.msg,res.title,setTimeout(function (){
                                	       window.location.reload();
                                            }, 4000)
                                        )
                        }
                    }
                });
            });
SCRIPT;
            $str = '';
            $button_ = ['待确认','待报价','待审核','待发货','已完成'];
            if($user_roles[0]['id'] == 4){//业务员组
                if($orderstatus ==1){
                    $str = '<button class="btn btn-primary btn-xs">'.$button_[$orderstatus-1].'</button> | <button class="btn btn-warning btn-xs comfirmorder" data-id="'.$this->id.'">确认订单</button>';
                }else{
                    $str = '<button class="btn btn-primary btn-xs">'.$button_[$orderstatus-1].'</button>';
                }
            }else if($user_roles[0]['id'] == 5){//经销商组
                if($orderstatus ==2){
                    $str = '<button class="btn btn-primary btn-xs">'.$button_[$orderstatus-1].'</button> | <button class="btn btn-warning btn-xs comfirmorder" data-id="'.$this->id.'">确认订单</button>';
                }else{
                    $str = '<button class="btn btn-primary btn-xs">'.$button_[$orderstatus-1].'</button>';
                }
            }else if($user_roles[0]['id'] == 6){//批发部
                if($orderstatus ==3){
                    $str = '<button class="btn btn-primary btn-xs">'.$button_[$orderstatus-1].'</button> | <button class="btn btn-warning btn-xs comfirmorder" data-id="'.$this->id.'">确认报价</button>';
                }else{
                    $str = '<button class="btn btn-primary btn-xs">'.$button_[$orderstatus-1].'</button>';
                }
            }else if($user_roles[0]['id'] == 7){//财务部
                if($orderstatus ==4){
                    $str = '<button class="btn btn-primary btn-xs">'.$button_[$orderstatus-1].'</button> | <button class="btn btn-warning btn-xs comfirmorder" data-id="'.$this->id.'">确认收款</button>';
                }else{
                    $str = '<button class="btn btn-primary btn-xs">'.$button_[$orderstatus-1].'</button>';
                }
            }else if($user_roles[0]['id'] == 8){//仓库
                if($orderstatus ==5){
                    $str = '<button class="btn btn-primary btn-xs">'.$button_[$orderstatus-1].'</button> | <button class="btn btn- btn-xs comfirmorder" data-id="'.$this->id.'">确认发货</button>';
                }else{
                    $str = '<button class="btn btn-primary btn-xs">'.$button_[$orderstatus-1].'</button>';
                }
            }else{
                
            }
            Admin::script($js);
            return $str;
        });
        $grid->disableFilter();
        $grid->disableCreateButton();
        $grid->disableColumnSelector();
        $grid->disableActions();
        return $grid;
    }

    /**
     * Make a show builder.
     *
     * @param mixed $id
     * @return Show
     */
    protected function detail($id)
    {
        $show = new Show(Order::findOrFail($id));



        return $show;
    }

    /**
     * Make a form builder.
     *
     * @return Form
     */
    protected function form()
    {
        $form = new Form(new Order());
        $form->text('gift','赠品');


        return $form;
    }
}
