<?php
namespace App\Admin\Controllers;

use App\Medicinal;
use App\Order;
use App\Salelist;
use App\Site;
use Encore\Admin\Controllers\AdminController;
use Maatwebsite\Excel\Facades\Excel;
use App\Hospital;
use App\Hospitalprice;
use Encore\Admin\Layout\Content;
class PrintsController extends AdminController{
    protected $title = '商品随货同行单';
    protected $defaults = ['购货单位：','收货单位：','单据号：','日期：','合计（大写）：','发货员：','复核员：','储运条件：','签收：','发货地址：','联系电话：'];
    protected $defaultOne = ['购货单位：','编号：','部门：','业务员：','开票员：','日期：','合计：','发货员：','复核员：','客户签字'];
    protected $column = ['A','B','C','D','E','F','G','H','I','J','K','L','M','M','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
    protected $template;
    public function startPrint(){
        if(request()->isMethod('post')){//经销商需要选择模板，用post提交
            $orderid = $_POST['id'];
            $this->template = (int)$_POST['template'];
            $orderAllInfo = Order::find($orderid)->toArray(true);
            $this->agentData($orderAllInfo);
               
        }else{//医院直接get提交
            
        }
    }
    
    public function hospitalPrint(Content $content){
        $ext = '出货单';
        $sendcompany = "武汉协同贸易有限公司";
        $headername = [];//出货单基础信息名
        $dataname = [];//订单货物标题
        $headername['hk'] = ['购货单位：','编号：','部门：','业务员：','开票员：','日期：','合计：','发货员：','复核员：','客户签字'];
        $headername['xzb'] =['采购订单号：','订单日期：','供应商：','收货单位：','送货人：','送货日期：','收货人：','收货日期：'];
        $headername['yx'] =['采购订单号：','订单日期：','供应商：','收货单位：','送货人：','送货日期：','收货人：','收货日期：'];
        $headername['et'] = ['供应单位：','采购人：','采购类型：','仓库：','订单号：','订单日期：','送货单号：','合计：','发货员：','复核员：','客户签收：']; 
        $headername['tj'] = ['商业公司全称：','送货单号：','单位地址电话：','收货单位：','科室','送货日期：','合计：','收货单位及经手人签字：'];
        $headername['ds'] = ['购货单位：','开票日期：','发票号：','合计：','送货人：','收货人：','联系方式：'];
        
        $dataname['hk'] = ['器械名称','规格型号','单位','数量','单价','金额','生产日期','批号','注册证书','有效期至'];
        $dataname['xzb'] = ['序号','产品编码','产品名称','规格型号','装箱规格','生产厂家','数量','单位','单价(元)','产品批号','产品有效期','医疗器械注册证书','医疗器械注册证有效期','备注'];
        $dataname['yx'] = ['序号','产品编码','产品名称','规格型号','装箱规格','生产厂家','数量','单位','单价(元)','产品批号','产品有效期','医疗器械注册证书','医疗器械注册证有效期'];
        $dataname['et'] = ['材料名称','规格型号','单位','生产批号','有效日期','单价(元)','数量','总价(元)','生产厂家','灭菌日期'];
        $dataname['tj'] = ['产品编号','品名','规格','单位','数量','单价','金额','生产批号','有效期','备注','产地'];
        $dataname['ds'] = ['药品编号','商品名称','生产厂家','型号规格','单位','数量','单价','金额','生产批号','灭菌批号','有效期至','科室'];
        $orderid = $_GET['id'];
        $orderAllInfo = Order::find($orderid)->toArray(true);
        $hospitalinfo = Hospital::find($orderAllInfo['hospital']);
        $content->title($hospitalinfo['hospital'].$ext);
        $title = $hospitalinfo['hospital'].$ext;
        $orderinfo = json_decode($orderAllInfo['orderinfo'], true);
        $tabletitle = [];
        $data = [];
        $totalprice = 0;
        foreach ($orderinfo as $key=>$val){
            $medicinal = Medicinal::find($val['id']);
            $price = Hospitalprice::where([['hospitalid',$orderAllInfo['hospital']],['medicinalid',$val['id']]])->value('price');
            $totalprice +=  $val['num']*$price;
            $registivalidate = date('Y-m-d', strtotime($medicinal['registivalidate']));
            $data[] = array(
                //药品基础信息
                'medicinal' => $medicinal['medicinal'],
                'medicinalnum' => $medicinal['medicinalnum'],
                'manufacturinglicense' => $medicinal['manufacturinglicense'],
                'manufactur' => $medicinal['manufactur'],
                'specification' => $medicinal['specification'],
                'unit' => $medicinal['unit'],
                'batchnumber' => $medicinal['batchnumber'],
                'makedate' => empty($medicinal['makedate'])?'':date('Y-m-d',strtotime($medicinal['makedate'])),
                'registnum' => $medicinal['registnum'],
                'registivalidate' => empty($registivalidate)?$medicinal['registivalidate']:$registivalidate,
                'invalidate' => empty($medicinal['invalidate'])?'':date('Y-m-d',strtotime($medicinal['invalidate'])),
                'storagecondition' => $medicinal['storagecondition'],
                //订单信息
                'price' => $price,
                'prices' => $val['num']*$price,
                'num' => $val['num'],
                'gift' => $orderAllInfo['gift'],
                //额外信息
                'boxformat' =>'',//装箱规格
                'novirus' =>'',//灭菌批号
                'depart' => '',//部门
            );
        }
        $totalcn = $this->get_amount($totalprice);
        if($hospitalinfo['hospital'] == '中国人民解放军中部战区总医院（汉口院区）'){
            $tabletitle = [$title,
                $headername['hk'][0].$hospitalinfo['hospital'],
                $headername['hk'][1].$orderAllInfo['orderid'],
                $headername['hk'][2],
                $headername['hk'][3],
                $headername['hk'][4],
                $headername['hk'][5].date('Y-m-d',strtotime($orderAllInfo['created_at'])),
                $headername['hk'][6],
                $headername['hk'][7],
                $headername['hk'][8],
                $headername['hk'][9]
                
            ];
            $content->body(view('admin.prints.hankou',['tabletitle'=>$tabletitle,'datatitle'=>$dataname['hk'],'lists'=>$data, 'total'=>$totalprice, 'totalcn'=>$totalcn])->render());
            return $content;
        }else if($hospitalinfo['hospital'] == '武汉亚洲心脏病医院'){
            $tabletitle = [$title, 
                $headername['xzb'][0].$orderAllInfo['orderid'],
                $headername['xzb'][1].date('Y-m-d',strtotime($orderAllInfo['created_at'])),
                $sendcompany,
                $hospitalinfo['hospital'],
                $headername['xzb'][4],
                $headername['xzb'][5],
                $headername['xzb'][6],
                $headername['xzb'][7]
            ];
            $content->body(view('admin.prints.xinzangbing', 
                ['tabletitle'=>$tabletitle,'datatitle'=>$dataname['xzb'],'lists'=>$data, 'total'=>$totalprice, 'totalcn'=>$totalcn]
                )->render());
            return $content;
        }else if($hospitalinfo['hospital'] == '武汉亚心总医院有限公司'){
            $tabletitle = [$title,
                $headername['xzb'][0].$orderAllInfo['orderid'],
                $headername['xzb'][1].date('Y-m-d',strtotime($orderAllInfo['created_at'])),
                $sendcompany,
                $hospitalinfo['hospital'],
                $headername['xzb'][4],
                $headername['xzb'][5],
                $headername['xzb'][6],
                $headername['xzb'][7]
            ];
            $content->body(view('admin.prints.yaxin',
                ['tabletitle'=>$tabletitle,'datatitle'=>$dataname['xzb'],'lists'=>$data, 'total'=>$totalprice, 'totalcn'=>$totalcn]
                )->render());
            return $content;
        }else if($hospitalinfo['hospital'] == '武汉儿童医院'){
            $tabletitle = [$title,
                $headername['et'][0].$sendcompany,
                $headername['et'][1].$hospitalinfo['contactman'],
                $headername['et'][2],
                $headername['et'][3],
                $headername['et'][4].$orderAllInfo['orderid'],
                $headername['et'][5].date('Y/m/d', strtotime($orderAllInfo['created_at'])),
                $headername['et'][6],
                $headername['et'][7],
                $headername['et'][8],
                $headername['et'][9],
                $headername['et'][10]
            ];
            $content->body(view('admin.prints.ertong',
                ['tabletitle'=>$tabletitle,'datatitle'=>$dataname['et'],'lists'=>$data, 'total'=>$totalprice, 'totalcn'=>$totalcn]
                )->render());
            return $content;
        }else if($hospitalinfo['hospital'] == '同济医院'){
            $tabletitle = [$title,
                $headername['tj'][0].$sendcompany,
                $headername['tj'][1],
                $headername['tj'][2].$hospitalinfo['address'],
                $headername['tj'][3].$hospitalinfo['hospital'],
                $headername['tj'][4],
                $headername['tj'][5],
                $headername['tj'][6],
                $headername['tj'][7]
            ];
            $content->body(view('admin.prints.tongji',
                ['tabletitle'=>$tabletitle,'datatitle'=>$dataname['tj'],'lists'=>$data, 'total'=>$totalprice, 'totalcn'=>$totalcn]
                )->render());
            return $content;
        }else if($hospitalinfo['hospital'] == '武汉市第四医院'){
            $tabletitle = [$title,
                $headername['ds'][0].$hospitalinfo['hospital'],
                $headername['ds'][1],
                $headername['ds'][2],
                $headername['ds'][3],
                $headername['ds'][4],
                $headername['ds'][5],
                $headername['ds'][6]
            ];
            $content->body(view('admin.prints.disi',
                ['tabletitle'=>$tabletitle,'datatitle'=>$dataname['ds'],'lists'=>$data, 'total'=>$totalprice, 'totalcn'=>$totalcn]
                )->render());
            return $content;
        }else if($hospitalinfo['hospital'] == '武汉大学人民医院'){
            
            $content->body(view('admin.prints.renmin')->render());
            return $content;
        }else if($hospitalinfo['hospital'] == '省妇幼'){
            
            $content->body(view('admin.prints.fuyou')->render());
            return $content;
        }else if($hospitalinfo['hospital'] == '武汉市中心医院'){
            
            $content->body(view('admin.prints.zhongxin')->render());
            return $content;
        }else if($hospitalinfo['hospital'] == '武汉大学中南医院'){
            
            $content->body(view('admin.prints.zhongnan')->render());
            return $content;
        }else{
            
        }
    }
   
    /*    
    * 数字金额转换成中文大写金额的函数
    * @param String|Int  $num  要转换的小写数字或小写字符串
    *return 大写字母
    *小数位为两位
    **/
    protected function get_amount($num){
        $c1 = "零壹贰叁肆伍陆柒捌玖";
        $c2 = "分角元拾佰仟万拾佰仟亿";
        $num = round($num, 2);
        $num = $num * 100;
        if (strlen($num) > 10) {
            return "数据太长，没有这么大的钱吧，检查下";
        } 
        $i = 0;
        $c = "";
        while (1) {
            if ($i == 0) {
                $n = substr($num, strlen($num)-1, 1);
            } else {
                $n = $num % 10;
            } 
            $p1 = substr($c1, 3 * $n, 3);
            $p2 = substr($c2, 3 * $i, 3);
            if ($n != '0' || ($n == '0' && ($p2 == '亿' || $p2 == '万' || $p2 == '元'))) {
                $c = $p1 . $p2 . $c;
            } else {
                $c = $p1 . $c;
            } 
            $i = $i + 1;
            $num = $num / 10;
            $num = (int)$num;
            if ($num == 0) {
                break;
            } 
        }
        $j = 0;
        $slen = strlen($c);
        while ($j < $slen) {
            $m = substr($c, $j, 6);
            if ($m == '零元' || $m == '零万' || $m == '零亿' || $m == '零零') {
                $left = substr($c, 0, $j);
                $right = substr($c, $j + 3);
                $c = $left . $right;
                $j = $j-3;
                $slen = $slen-3;
            } 
            $j = $j + 3;
        } 
 
        if (substr($c, strlen($c)-3, 3) == '零') {
            $c = substr($c, 0, strlen($c)-3);
        }
        if (empty($c)) {
            return "零元整";
        }else{
            return $c . "整";
        }
    }
}