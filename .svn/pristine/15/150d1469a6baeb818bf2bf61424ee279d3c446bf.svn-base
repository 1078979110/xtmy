<?php

namespace App\Admin\Controllers;

use Encore\Admin\Controllers\AdminController;
use Encore\Admin\Layout\Content;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Facades\Storage;
use Maatwebsite\Excel\Facades\Excel;
use App\Producer;
use App\Productline;
use App\Category;
use App\Medicinal;
use App\Hospitalprice;
use App\Admin\Extensions\Tools\SetPrice;
use Illuminate\Http\Request;

class ApiController extends AdminController{
    public function line(){
        $producer_id = $_GET['q'];
        return Category::getLineIdNameById($producer_id);
    }
    public function category(){
        $line_id = $_GET['q'];
        return Category::getCategoryIdNameById($line_id);
    }
    
    public function medicinalStatus(){
        $id = $_POST['id'];
        $status = $_POST['status'];
        if($status == 1){
            $nowstatus = 0;
        }else{
            $nowstatus = 1;
        }
        $result = Medicinal::where('id', $id)->update(['status'=>$nowstatus]);
        if($result){
            return ['status'=>true,'title'=>'操作','msg'=>'操作成功'];
        }else{
            return ['status'=>false,'title'=>'操作','msg'=>'失败，请稍后再试'];
        }
    }
    
    public function getMedicinals(Request $request){
        $medicinal = $request->get('q');
        return Medicinal::orWhere('medicinal','like', '%'.$medicinal.'%')->orWhere('medicinalnum','like','%'.$medicinal.'%')->orWhere('batchnumber','like','%'.$medicinal.'%')->paginate(null,['id','medicinal as text','specification']);
    }
    
    public function medicinals(Content $content){
        if(request()->isMethod('post')){
            $excel = request()->file('excel');
            $ext_arr = ['xls','xlsx'];
            $re = $this->uploadFile($excel, $ext_arr);
            if($re['status'] =='error' ){
                admin_toastr($re['msg'], $re['status']);
                return redirect('/admin/excel/medicinals');
            }else{
                try{
                    $filename = $re['info'];
                    $producers = Producer::pluck('id','name');
                    $lines = Productline::pluck('id','linename');
                    $categories = Category::pluck('id','categoryname');
                    if(!is_file('storage\\'.$filename)){
                        admin_toastr('文件不存在！','error');
                        return redirect('/admin/excel/medicinals');
                    }
                    Excel::load('storage\\'.$filename, function($reader) use($producers,$lines,$categories){
                        $data = $reader->get()->toArray(true);
                        foreach ($data as $key=>$val){
                            if(!isset($val['器械名称']) || empty($val['器械名称'])){
                                admin_toastr('excel表数据结构与模板不相符，请修改后再进行导入！','error');
                                return redirect('/admin/excel/medicinals');
                            }
                            $makedate = (array)$val['生产日期']?(array)$val['生产日期']:'';
                            $invalidate = (array)$val['失效日期']?(array)$val['失效日期']:'';
                            $registivalidate = (array)$val['注册证失效日期']?(array)$val['注册证失效日期']:'';
                            $value['medicinal'] = $val['器械名称'];
                            $value['medicinalnum'] = $val['药品编号']?$val['药品编号']:'';
                            $value['manufacturinglicense'] = $val['许可证号']?$val['许可证号']:'';
                            $value['manufactur'] = $val['生产厂商']?$val['生产厂商']:'';
                            $value['producer_id'] = $producers[$val['厂家']]?$producers[$val['厂家']]:'';
                            $value['line_id'] = $lines[$val['产品线']]?$lines[$val['产品线']]:'';
                            $value['category_id'] = $categories[$val['产品分类']]?$categories[$val['产品分类']]:'';
                            $value['specification'] = $val['规格型号']?$val['规格型号']:'';
                            $value['unit'] = $val['单位'];
                            $value['stock'] = $val['数量']?$val['数量']:0;
                            $value['batchnumber'] = $val['批号']?$val['批号']:'';
                            $value['makedate'] = isset($makedate['date'])?$makedate['date']:(empty($makedate)?'':$makedate[0]);
                            $value['invalidate'] = isset($invalidate['date'])?$invalidate['date']:(empty($invalidate)?'':$invalidate[0]);
                            $value['registnum'] = $val['注册证号']?$val['注册证号']:'';
                            $value['registivalidate'] = isset($registivalidate['date'])?$registivalidate['date']:(empty($registivalidate)?'':$registivalidate[0]);
                            $value['storagecondition'] = $val['储存条件']?$val['储存条件']:'';
                            $value['status'] = isset($val['status'])?$val['status']:0;
                            Medicinal::create($value); 
                        }
                    });
                    admin_toastr('导入成功','success');
                    return redirect('/admin/medicinals');
                }catch (\Exception $e){
                    return $e->getMessage();
                }
            }
        }
    }
    
    public function setPrice(){
        if(request()->isMethod('post')){
            $excel = request()->file('excel');
            $ext_arr = ['xls','xlsx'];
            $re = $this->uploadFile($excel, $ext_arr);
            $hospital = request()->post('hospitalid');
            if($re['status'] =='error' ){
                admin_toastr($re['msg'], $re['status']);
                return redirect('/admin/excel/setprice');
            }else{
                try{
                    $filename = $re['info'];
                    $medicinals = Medicinal::pluck('id','medicinalnum');
                    if(!is_file('storage\\'.$filename)){
                        admin_toastr('文件不存在！','error');
                        return redirect('/admin/excel/setprice');
                    }
                    Excel::load('storage\\'.$filename, function($reader) use($medicinals,$hospital){
                        $data = $reader->get()->toArray(true);
                        $value = [];
                        foreach ($data as $key=>$val){
                            if(!isset($val['产品编号']) || empty($val['产品编号'] || !isset($val['price']) || empty($val['price']))){
                                admin_toastr('excel表数据结构与模板不相符，请修改后再进行导入！','error');
                                return redirect('/admin/excel/setprice');
                            }
                            $value['hospitalid'] = $hospital;
                            $value['medicinalid'] = $medicinals[$val['产品编号']];
                            $value['price'] = $val['价格'];
                            Hospitalprice::create($value);
                        }
                    });
                        admin_toastr('导入成功','success');
                        return redirect('/admin/medicinals');
                }catch (\Exception $e){
                    return $e->getMessage();
                }
            }
        }
    } 
    
    /**
     * 
     * @param $file 文件对象
     * @param array $option 后缀名，数组
     */
    protected function uploadFile($file ,$option, $disk='admin'){
        if (! $file->isValid()) {
            return array('status'=>'error','msg'=>'文件已上传');
        }
        $fileExtension = $file->getClientOriginalExtension();
        if(! in_array($fileExtension, $option)) {
            return array('status'=>'error','msg'=>'文件类型不正确');
        }
        $tmpFile = $file->getRealPath();
        if (! is_uploaded_file($tmpFile)) {
            return array('status'=>'error','msg'=>'非法上传途径');
        }
        $fileName = date('Y_m_d').'/'.md5(time()) .mt_rand(0,9999).'.'. $fileExtension;
        if (Storage::disk($disk)->put($fileName, file_get_contents($tmpFile)) ){
            return array('status'=>'success', 'msg'=>'上传成功','info'=>$fileName);
        } 
    }
}